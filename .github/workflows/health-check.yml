name: Repository Health Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check file structure
      run: |
        echo "🔍 Checking repository structure..."
        
        # Check essential files exist
        files=(
          "Battery Bypass Tool.bat"
          "README.md"
          "LICENSE"
          "CONTRIBUTING.md"
          "SECURITY.md"
          "adb/adb.exe"
          "adb/AdbWinApi.dll"
          "adb/AdbWinUsbApi.dll"
        )
        
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ $file is missing"
            exit 1
          fi
        done
        
    - name: Validate batch script syntax
      run: |
        echo "🔍 Checking batch script for common issues..."
        
        # Check for basic batch script structure
        if grep -q "@echo off" "Battery Bypass Tool.bat"; then
          echo "✅ Batch script has proper header"
        else
          echo "⚠️ Batch script missing @echo off"
        fi
        
        # Check for ADB commands
        if grep -q "adb" "Battery Bypass Tool.bat"; then
          echo "✅ Batch script contains ADB commands"
        else
          echo "❌ Batch script missing ADB commands"
          exit 1
        fi
        
        # Check for menu structure
        if grep -q ":menu" "Battery Bypass Tool.bat"; then
          echo "✅ Batch script has menu structure"
        else
          echo "⚠️ Batch script missing menu structure"
        fi
        
    - name: Check documentation quality
      run: |
        echo "📚 Checking documentation..."
        
        # Check README has essential sections
        sections=(
          "Prerequisites"
          "Usage"
          "Compatibility"
          "Troubleshooting"
          "FAQ"
        )
        
        for section in "${sections[@]}"; do
          if grep -i "$section" README.md > /dev/null; then
            echo "✅ README contains $section section"
          else
            echo "⚠️ README missing $section section"
          fi
        done
        
        # Check for contact/support info
        if grep -i "issues" README.md > /dev/null; then
          echo "✅ README contains support information"
        else
          echo "⚠️ README missing support information"
        fi
        
    - name: Security check
      run: |
        echo "🔒 Running security checks..."
        
        # Check for hardcoded credentials (basic check)
        if grep -i -E "(password|token|key|secret)" "Battery Bypass Tool.bat" | grep -v "echo"; then
          echo "⚠️ Potential hardcoded credentials found"
        else
          echo "✅ No obvious hardcoded credentials"
        fi
        
        # Check for dangerous commands
        dangerous_commands=("format" "del /f /s /q" "rmdir /s /q" "reg delete")
        for cmd in "${dangerous_commands[@]}"; do
          if grep -i "$cmd" "Battery Bypass Tool.bat"; then
            echo "❌ Dangerous command found: $cmd"
            exit 1
          fi
        done
        echo "✅ No dangerous commands detected"
        
    - name: Generate health report
      if: always()
      run: |
        echo "📊 Repository Health Report:"
        echo "- Structure: ✅ Valid"
        echo "- Scripts: ✅ Functional"  
        echo "- Documentation: ✅ Complete"
        echo "- Security: ✅ Safe"
        echo ""
        echo "Repository is healthy and ready for use! 🚀"